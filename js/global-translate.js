// „Ç∞„É≠„Éº„Éê„É´ÁøªË®≥„Ç∑„Çπ„ÉÜ„É† - ÂÖ®‰∏ñÁïåÂØæÂøú
// yodobloom SAKEÂ∞ÇÁî®

class GlobalTranslate {
    constructor() {
        this.currentLanguage = 'ja';
        this.isInitialized = false;
        
        // ‰∏ñÁïå‰∏ªË¶ÅË®ÄË™ûÔºàÂú∞ÂüüÂà•Ôºâ
        this.languages = {
            // Êù±„Ç¢„Ç∏„Ç¢
            'ja': { name: 'Êó•Êú¨Ë™û', flag: 'üáØüáµ', region: 'asia' },
            'ko': { name: 'ÌïúÍµ≠Ïñ¥', flag: 'üá∞üá∑', region: 'asia' },
            'zh-cn': { name: 'ÁÆÄ‰Ωì‰∏≠Êñá', flag: 'üá®üá≥', region: 'asia' },
            'zh-tw': { name: 'ÁπÅÈ´î‰∏≠Êñá', flag: 'üáπüáº', region: 'asia' },
            
            // Êù±Âçó„Ç¢„Ç∏„Ç¢
            'th': { name: '‡πÑ‡∏ó‡∏¢', flag: 'üáπüá≠', region: 'asia' },
            'vi': { name: 'Ti·∫øng Vi·ªát', flag: 'üáªüá≥', region: 'asia' },
            'ms': { name: 'Bahasa Malaysia', flag: 'üá≤üáæ', region: 'asia' },
            'id': { name: 'Bahasa Indonesia', flag: 'üáÆüá©', region: 'asia' },
            
            // Âçó„Ç¢„Ç∏„Ç¢
            'hi': { name: '‡§π‡§ø‡§®‡•ç‡§¶‡•Ä', flag: 'üáÆüá≥', region: 'asia' },
            
            // Ê¨ßÁ±≥
            'en': { name: 'English', flag: 'üá∫üá∏', region: 'western' },
            'es': { name: 'Espa√±ol', flag: 'üá™üá∏', region: 'western' },
            'fr': { name: 'Fran√ßais', flag: 'üá´üá∑', region: 'western' },
            'de': { name: 'Deutsch', flag: 'üá©üá™', region: 'western' },
            'it': { name: 'Italiano', flag: 'üáÆüáπ', region: 'western' },
            'pt': { name: 'Portugu√™s', flag: 'üáµüáπ', region: 'western' },
            'ru': { name: '–†—É—Å—Å–∫–∏–π', flag: 'üá∑üá∫', region: 'western' },
            
            // ‰∏≠Êù±„Éª„Ç¢„Éï„É™„Ç´
            'ar': { name: 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©', flag: 'üá∏üá¶', region: 'middle_east' }
        };
        
        this.init();
    }
    
    init() {
        if (this.isInitialized) return;
        
        this.createGlobalUI();
        this.setupGoogleTranslate();
        this.bindEvents();
        this.detectUserLanguage();
        
        this.isInitialized = true;
        console.log('üåç Global Translate System initialized');
    }
    
    createGlobalUI() {
        // Êó¢Â≠ò„ÅÆÁøªË®≥UI„ÇíÂâäÈô§
        document.querySelectorAll('[id*="translate"], [class*="translate"]').forEach(el => {
            if (el.id !== 'google_translate_element') {
                el.remove();
            }
        });
        
        const globalUI = `
            <div id="globalTranslateSystem" class="global-translate">
                <button id="globalTranslateBtn" class="global-translate-btn">
                    <span class="current-flag">üáØüáµ</span>
                    <span class="current-lang">Êó•Êú¨Ë™û</span>
                    <span class="translate-arrow">üåê</span>
                </button>
                
                <div id="globalTranslatePanel" class="global-translate-panel">
                    <div class="translate-header">
                        <h3>üåç Ë®ÄË™ûÈÅ∏Êäû / Language</h3>
                        <button id="closeTranslatePanel" class="close-btn">√ó</button>
                    </div>
                    
                    <div class="language-regions">
                        <div class="region-section">
                            <h4>üèØ „Ç¢„Ç∏„Ç¢ / Asia</h4>
                            <div class="language-grid">
                                ${this.renderLanguagesByRegion('asia')}
                            </div>
                        </div>
                        
                        <div class="region-section">
                            <h4>üèõÔ∏è Ê¨ßÁ±≥ / Western</h4>
                            <div class="language-grid">
                                ${this.renderLanguagesByRegion('western')}
                            </div>
                        </div>
                        
                        <div class="region-section">
                            <h4>üïå ‰∏≠Êù±„Éª„Åù„ÅÆ‰ªñ / Others</h4>
                            <div class="language-grid">
                                ${this.renderLanguagesByRegion('middle_east')}
                            </div>
                        </div>
                    </div>
                    
                    <div class="translate-footer">
                        <small>Powered by Google Translate</small>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', globalUI);
        this.addGlobalStyles();
    }
    
    renderLanguagesByRegion(region) {
        return Object.entries(this.languages)
            .filter(([code, lang]) => lang.region === region)
            .map(([code, lang]) => `
                <button class="lang-option" data-lang="${code}">
                    <span class="lang-flag">${lang.flag}</span>
                    <span class="lang-name">${lang.name}</span>
                </button>
            `).join('');
    }
    
    addGlobalStyles() {
        const style = document.createElement('style');
        style.id = 'global-translate-styles';
        style.textContent = `
            .global-translate {
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 999999;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            }
            
            .global-translate-btn {
                background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
                border: 2px solid #e9ecef;
                border-radius: 12px;
                padding: 10px 16px;
                display: flex;
                align-items: center;
                gap: 8px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 500;
                color: #495057;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                transition: all 0.3s ease;
                min-width: 140px;
            }
            
            .global-translate-btn:hover {
                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                border-color: #007bff;
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(0, 123, 255, 0.2);
            }
            
            .current-flag {
                font-size: 18px;
            }
            
            .current-lang {
                flex: 1;
            }
            
            .translate-arrow {
                font-size: 16px;
                opacity: 0.7;
            }
            
            .global-translate-panel {
                position: absolute;
                top: 100%;
                right: 0;
                margin-top: 10px;
                background: white;
                border-radius: 16px;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
                border: 1px solid #e9ecef;
                min-width: 400px;
                max-width: 90vw;
                max-height: 70vh;
                overflow: hidden;
                opacity: 0;
                visibility: hidden;
                transform: translateY(-10px);
                transition: all 0.3s ease;
            }
            
            .global-translate-panel.active {
                opacity: 1;
                visibility: visible;
                transform: translateY(0);
            }
            
            .translate-header {
                background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
                color: white;
                padding: 16px 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .translate-header h3 {
                margin: 0;
                font-size: 16px;
                font-weight: 600;
            }
            
            .close-btn {
                background: none;
                border: none;
                color: white;
                font-size: 20px;
                cursor: pointer;
                padding: 0;
                width: 24px;
                height: 24px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                transition: background 0.2s ease;
            }
            
            .close-btn:hover {
                background: rgba(255, 255, 255, 0.2);
            }
            
            .language-regions {
                padding: 20px;
                max-height: 50vh;
                overflow-y: auto;
            }
            
            .region-section {
                margin-bottom: 24px;
            }
            
            .region-section:last-child {
                margin-bottom: 0;
            }
            
            .region-section h4 {
                margin: 0 0 12px 0;
                font-size: 14px;
                font-weight: 600;
                color: #495057;
                border-bottom: 1px solid #e9ecef;
                padding-bottom: 8px;
            }
            
            .language-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
                gap: 8px;
            }
            
            .lang-option {
                background: #f8f9fa;
                border: 1px solid #e9ecef;
                border-radius: 8px;
                padding: 10px 12px;
                display: flex;
                align-items: center;
                gap: 8px;
                cursor: pointer;
                font-size: 13px;
                font-weight: 500;
                color: #495057;
                transition: all 0.2s ease;
            }
            
            .lang-option:hover {
                background: #007bff;
                border-color: #007bff;
                color: white;
                transform: translateY(-1px);
            }
            
            .lang-flag {
                font-size: 16px;
            }
            
            .lang-name {
                flex: 1;
                text-align: left;
            }
            
            .translate-footer {
                background: #f8f9fa;
                padding: 12px 20px;
                text-align: center;
                border-top: 1px solid #e9ecef;
                color: #6c757d;
            }
            
            /* „É¢„Éê„Ç§„É´ÂØæÂøú */
            @media (max-width: 768px) {
                .global-translate {
                    top: 16px;
                    right: 16px;
                }
                
                .global-translate-btn {
                    padding: 8px 12px;
                    font-size: 13px;
                    min-width: 120px;
                }
                
                .global-translate-panel {
                    min-width: 320px;
                    max-width: calc(100vw - 32px);
                    right: 0;
                }
                
                .language-grid {
                    grid-template-columns: 1fr;
                }
                
                .lang-option {
                    min-height: 44px;
                }
            }
            
            /* Google Translate„Éê„Éä„ÉºÈùûË°®Á§∫ */
            .goog-te-banner-frame,
            .goog-te-ftab-frame {
                display: none !important;
            }
            
            body {
                top: 0 !important;
            }
        `;
        
        document.head.appendChild(style);
    }
    
    setupGoogleTranslate() {
        // Google TranslateË¶ÅÁ¥†„ÅÆÊ∫ñÂÇô
        if (!document.getElementById('google_translate_element')) {
            const div = document.createElement('div');
            div.id = 'google_translate_element';
            div.style.display = 'none';
            document.body.appendChild(div);
        }
        
        // Google TranslateÂàùÊúüÂåñ
        window.googleTranslateElementInit = () => {
            if (typeof google !== 'undefined' && google.translate) {
                try {
                    // Êó¢Â≠ò„ÅÆÁøªË®≥Ë¶ÅÁ¥†„ÇíÂâäÈô§
                    const existingGoogleBar = document.querySelector('.goog-te-banner-frame');
                    if (existingGoogleBar) {
                        existingGoogleBar.remove();
                    }
                    
                    new google.translate.TranslateElement({
                        pageLanguage: 'ja',
                        includedLanguages: Object.keys(this.languages).join(','),
                        layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
                        autoDisplay: false
                    }, 'google_translate_element');
                    
                    // ÁøªË®≥Ê∫ñÂÇôÂÆå‰∫Ü„ÅÆÁ¢∫Ë™ç
                    setTimeout(() => {
                        const selectElement = document.querySelector('.goog-te-combo');
                        if (selectElement) {
                            console.log('‚úÖ Google Translate ready and functional');
                            this.showTranslationReady();
                        } else {
                            console.warn('‚ö†Ô∏è Google Translate select not found, retrying...');
                            setTimeout(() => window.googleTranslateElementInit(), 1000);
                        }
                    }, 1000);
                    
                } catch (error) {
                    console.error('Google Translate initialization error:', error);
                    this.showTranslationError();
                }
            } else {
                console.warn('Google Translate API not loaded, retrying...');
                setTimeout(() => window.googleTranslateElementInit(), 2000);
            }
        };
        
        // „Çπ„ÇØ„É™„Éó„ÉàË™≠„ÅøËæº„Åø
        if (!document.querySelector('script[src*="translate.google.com"]')) {
            const script = document.createElement('script');
            script.src = 'https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit';
            script.async = true;
            document.head.appendChild(script);
        } else {
            setTimeout(window.googleTranslateElementInit, 100);
        }
    }
    
    bindEvents() {
        const btn = document.getElementById('globalTranslateBtn');
        const panel = document.getElementById('globalTranslatePanel');
        const closeBtn = document.getElementById('closeTranslatePanel');
        
        // „Éë„Éç„É´ÈñãÈñâ
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            panel.classList.toggle('active');
        });
        
        closeBtn.addEventListener('click', () => {
            panel.classList.remove('active');
        });
        
        // Ë®ÄË™ûÈÅ∏Êäû
        panel.addEventListener('click', (e) => {
            const langOption = e.target.closest('.lang-option');
            if (langOption) {
                const langCode = langOption.dataset.lang;
                this.translateTo(langCode);
                panel.classList.remove('active');
            }
        });
        
        // Â§ñÈÉ®„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.global-translate')) {
                panel.classList.remove('active');
            }
        });
    }
    
    translateTo(langCode) {
        if (!this.languages[langCode]) return;
        
        const lang = this.languages[langCode];
        const btn = document.getElementById('globalTranslateBtn');
        
        // „Éú„Çø„É≥Êõ¥Êñ∞
        btn.querySelector('.current-flag').textContent = lang.flag;
        btn.querySelector('.current-lang').textContent = lang.name;
        
        // Google Translate„ÅßÁøªË®≥ÂÆüË°å
        setTimeout(() => {
            const select = document.querySelector('.goog-te-combo');
            if (select) {
                select.value = langCode;
                select.dispatchEvent(new Event('change'));
            }
        }, 300);
        
        this.currentLanguage = langCode;
        console.log(`üåç Language changed to: ${lang.name}`);
    }
    
    showTranslationReady() {
        // ÁøªË®≥Ê∫ñÂÇôÂÆå‰∫Ü„ÅÆË°®Á§∫
        const btn = document.getElementById('globalTranslateBtn');
        if (btn) {
            btn.style.borderColor = '#28a745';
            btn.title = 'ÁøªË®≥Ê©üËÉΩ„ÅåÂà©Áî®ÂèØËÉΩ„Åß„Åô';
        }
    }
    
    showTranslationError() {
        // ÁøªË®≥„Ç®„É©„Éº„ÅÆË°®Á§∫
        const btn = document.getElementById('globalTranslateBtn');
        if (btn) {
            btn.style.borderColor = '#dc3545';
            btn.title = 'ÁøªË®≥Ê©üËÉΩ„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
        }
    }
    
    detectUserLanguage() {
        // „Éñ„É©„Ç¶„Ç∂Ë®ÄË™û„ÅÆËá™ÂãïÊ§úÂá∫
        const browserLang = navigator.language || navigator.userLanguage;
        const langCode = browserLang.split('-')[0];
        
        if (this.languages[langCode] && langCode !== 'ja') {
            setTimeout(() => {
                this.showLanguageSuggestion(langCode);
            }, 2000);
        }
    }
    
    showLanguageSuggestion(langCode) {
        const lang = this.languages[langCode];
        if (!lang) return;
        
        const suggestion = document.createElement('div');
        suggestion.className = 'language-suggestion';
        suggestion.innerHTML = `
            <div class="suggestion-content">
                <p>üåç ${lang.flag} Translate to ${lang.name}?</p>
                <div class="suggestion-actions">
                    <button class="suggest-yes" data-lang="${langCode}">Yes</button>
                    <button class="suggest-no">No, thanks</button>
                </div>
            </div>
        `;
        
        suggestion.style.cssText = `
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            border: 1px solid #e9ecef;
            z-index: 999998;
            animation: slideInUp 0.3s ease;
        `;
        
        document.body.appendChild(suggestion);
        
        // „Ç§„Éô„É≥„ÉàÂá¶ÁêÜ
        suggestion.addEventListener('click', (e) => {
            if (e.target.classList.contains('suggest-yes')) {
                this.translateTo(e.target.dataset.lang);
            }
            suggestion.remove();
        });
        
        // 10ÁßíÂæå„Å´Ëá™ÂãïÂâäÈô§
        setTimeout(() => {
            if (suggestion.parentNode) {
                suggestion.remove();
            }
        }, 10000);
    }
}

// ÂàùÊúüÂåñ
document.addEventListener('DOMContentLoaded', () => {
    try {
        window.globalTranslate = new GlobalTranslate();
        console.log('‚úÖ Global Translate System loaded');
    } catch (error) {
        console.error('‚ùå Global Translate System failed to load:', error);
    }
});